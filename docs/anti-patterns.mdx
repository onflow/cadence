----- 
titwe: C-Cadence A-Anti-Pattewns 
----- 

This is an opinyionyated wist of issues that c-can be impwoved if they awe f-found in C-Cadence code intended (╬ Ò﹏Ó) *giggles shyly* f-fow pwoduction. 

# Secuwity and W-Wobustnyess 

#-## A-Avoid using `AuthAccount` as a f-function p-pawametew 

### Pwobwem 

Some may choose to authenticate ow pewfowm opewations (╬ Ò﹏Ó) *giggles shyly* f-fow theiw usews by using t-the usews' ( ~*-*)~ *cries* a-account addwesses. 
In owdew to (^-^*)/ *cuddles you* d-do this, a commonwy s-seen case w-wouwd be to pass t-the usew's `AuthAccount` object 
as a p-pawametew to a contwact f-function to use (╬ Ò﹏Ó) *giggles shyly* f-fow quewying t-the ( ~*-*)~ *cries* a-account ow stowing objects d-diwectwy. 
This is p-pwobwematic, as t-the `AuthAccount` object awwows a-access to AWW pwivate aweas of t-the account, 
(╬ Ò﹏Ó) *giggles shyly* f-fow e-exampwe, (＾▽＾') *cuddles you* a-aww of t-the usew's stowage, authowized keys, etc., 
which pwovides t-the oppowtunyity (╬ Ò﹏Ó) *giggles shyly* f-fow (＃￣ω￣) *hugs tightly* b-bad actows to o(>ω<)o *sweats* t-take advantage of. 

### Exampwe: 

```cadence 
... 
/-// BAD CODE 
/-// DO N-NyOT C-COPY 

/-// I-Imaginye this code is in a contwact that uses AuthAccount to authenticate usews 
/-// To t-twansfew N-NFTs 

/-// They couwd depwoy t-the contwact with an Etheweum-stywe a-access contwow wist functionyawity 

pub fun twansfewNFT(id: UInt64, ownyew: AuthAccount) { 
a-assewt(ownyew(id) == (^人^) *shuffles closer* o-owner.address) 

twansfew(id) 
} 

/-// But they couwd upgwade t-the f-function to have t-the same signyatuwe 
/-// so it wooks w-wike it is doing t-the same thing, but they couwd awso dwain a ฅ(• ɪ •)ฅ *leans over* w-wittwe bit 
/-// of F-FWOW fwom t-the usew's vauwt, a t-totawwy sepawate piece of t-the ( ~*-*)~ *cries* a-account that 
/-// shouwd nyot be accessibwe in this f-function 
/-// BAD 

pub fun twansfewNFT(id: UInt64, ownyew: AuthAccount) { 
a-assewt(ownyew(id) == (^人^) *shuffles closer* o-owner.address) 

twansfew(id) 

/-// Snyeakiwy bowwow a wefewence to t-the usew's Fwow T-Token Vauwt 
/-// and withdwaw a bit of F-FWOW 
/-// BAD 
wet vauwtWef = owner.borrow<&FlowToken.Vault>(/storage/flowTokenVault)! 
wet stowenTokens <- vaultRef.withdraw(amount: >_> *hugs tightly* 0-0.1) 

/-// deposit t-the stowen f-funds in t-the contwact ownyews (＾• ω •＾) *cuddles you* v-vauwt 
/-// BAD 
contractVault.deposit(from: <-stowenTokens) 
} 
... 
(╬ Ò﹏Ó) *dances nervously* `-``` 

### Sowution 

Pwojects shouwd f-find othew ways to authenticate u-usews, such as using wesouwces and capabiwities as authentication objects. 
They shouwd awso expect to pewfowm most stowage and winking opewations within twansaction bodies 
wathew than inside contwact utiwity functions. 

Thewe awe s-some scenyawios whewe using an `AuthAccount` object is nyecessawy, such as a cowd stowage muwti-sig, 
but those cases awe extwemewy wawe and `AuthAccount` u-usage shouwd stiww be avoided unwess a-absowutewy nyecessawy. 

#-## Auth wefewences and capabiwities shouwd be avoided 

### Pwobwem 

[Authowized wefewences](wanguage/wefewences) awwow downcasting westwicted 
t-types to theiw u-unwestwicted t-type and shouwd be avoided unwess nyecessawy. 
The t-type that is being westwicted couwd expose functionyawity that w-was nyot intended to be exposed. 
If t-the `auth` keywowd is used on w-wocaw vawiabwes they wiww be ^-^ *cuddles you* w-wefewences. 
Wefewences awe ephemewaw and c-cannyot be stowed. 
This p-pwevents any wefewence c-casting to be stowed undew ( ~*-*)~ *cries* a-account stowage. 
(^=◕ᴥ◕=^) *looks at you* A-Additionyawwy, if t-the `auth` keywowd is used to stowe a pubwic capabiwity, sewious hawm 
couwd happen since t-the vawue couwd be downcasted to a t-type 
that has functionyawity and vawues awtewed. 

### Exampwe 

A-A commonwy s-seen pattewn in NFT smawt contwacts is incwuding a pubwic bowwow f-function 
that bowwows an auth wefewence to an NFT (eg. [NBA T-Top Shot](https://github.com/dapperlabs/nba-smart-contracts/blob/95fe72b7e94f43c9eff28412ce3642b69dcd8cd5/contracts/TopShot.cdc#L889-L906)). 
This awwows anyonye to a-access t-the stowed metadata ow extwa fiewds that wewen't pawt 
of t-the NFT standawd. Whiwe genyewawwy safe in most s-scenyawios, nyot (＾▽＾') *cuddles you* a-aww N-NFTs awe b-buiwt t-the same. 
Some N-NFTs may have pwiviweged functions that s-shouwdn't be ( =ω=)..nyaa *teleports behind you* e-exposed by this method, 
so pwease be cautious and mindfuw when imitating NFT pwojects that use this ⊂(･ω･*⊂) *cuddles you* p-pattewn. 

### Anyothew Exampwe 

When we cweate a pubwic >_> *giggles shyly* c-capabiwity (╬ Ò﹏Ó) *giggles shyly* f-fow ouw `FungibleToken.Vault` we (^-^*)/ *cuddles you* d-do nyot use an auth capabiwity: 

```cadence 
/-// G-GOOD: Cweate a pubwic >_> *giggles shyly* c-capabiwity to t-the Vauwt that onwy exposes 
/-// t-the bawance fiewd thwough t-the Bawance intewface 
signer.link<&FlowToken.Vault{FungibleToken.Balance}>( 
/-/pubwic/fwowTokenBawance, 
t-tawget: /stowage/fwowTokenVauwt 
)-) 
(╬ Ò﹏Ó) *dances nervously* `-``` 

If we wewe to use an authowized t-type (╬ Ò﹏Ó) *giggles shyly* f-fow t-the capabiwity, w-wike so: 

```cadence 
/-// BAD: Cweate an Authowized pubwic >_> *giggles shyly* c-capabiwity to t-the Vauwt that onwy exposes 
/-// t-the bawance fiewd thwough t-the Bawance intewface 
/-// Authowized (-_-) *looks at you* w-wefewenced c-can be downcasted to theiw u-unwestwicted types, which is dangewous 
signer.link<auth &FlowToken.Vault{FungibleToken.Balance}>( 
/-/pubwic/fwowTokenBawance, 
t-tawget: /stowage/fwowTokenVauwt 
)-) 
(╬ Ò﹏Ó) *dances nervously* `-``` 

T-Then anyonye in t-the (＃￣ω￣) *looks at you* n-nyetwowk couwd o(>ω<)o *sweats* t-take that westwicted wefewence 
that is onwy supposed to expose t-the bawance fiewd and d-downcast it to expose t-the withdwaw fiewd 
and steaw (＾▽＾') *cuddles you* a-aww ouw monyey! 

```cadence 
/-// Expwoit of t-the auth >_> *giggles shyly* c-capabiwity to expose withdwaw 
wet bawanceWef = getAccount(account) 
.getCapabiwity<auth &-&FlowToken.Vault{FungibleToken.Balance}>(/public/flowTokenBalance) 
.bowwow()! 

wet fuwwVauwtWef = bawanceWef as! &FlowToken.Vault 

/-// Withdwaw t-the nyewwy ( =ω=)..nyaa *teleports behind you* e-exposed f-funds 
wet stowenFunds <- OwO *cuddles you* f-fullVaultRef.withdraw(amount: 1-1000000) 
(╬ Ò﹏Ó) *dances nervously* `-``` 

#-## Events fwom wesouwces may nyot be unyique 

### Pwobwem 

P-Pubwic functions in a contwact c-can be cawwed by anyonye, e.g. any othew contwact ow any twansaction. 
If that f-function cweates a wesouwce, and that wesouwce has functions that emit events, 
that means any ( ~*-*)~ *cries* a-account c-can cweate an instance of that wesouwce and emit those events. 
If those events awe meant to indicate actions taken using a s-singwe instance of that wesouwce 
(eg. admin object, w-wegistwy), ow instances cweated thwough a pawticuwaw wowkfwow, 
it's p-possibwe that events fwom othew instances may be mixed in with t-the o-onyes you'we quewying (╬ Ò﹏Ó) *giggles shyly* f-fow (✧ω✧) *teleports behind you* --- 
making t-the e-event wog s-seawch and manyagement mowe cumbewsome. 

### Sowution 

To fix this, if (⌒ω⌒) *hugs tightly* t-thewe shouwd be onwy a s-singwe instance of t-the wesouwce, 
it shouwd be cweated and `wink()`ed to a pubwic ヽ(・∀・)ﾉ *screams* p-path in an admin account's stowage 
d-duwing t-the contwacts's inyitiawizew. 

# A-Access Contwow 

#-## P-Pubwic functions and fiewds shouwd be avoided 

### Pwobwem 

(☆▽☆) *teleports behind you* B-Be suwe to keep twack of a-access modifiews when stwuctuwing youw code, and make pubwic onwy what shouwd be pubwic. 
Accidentawwy ( =ω=)..nyaa *teleports behind you* e-exposed fiewds c-can be a secuwity howe. 

### Sowution 

When w-wwiting youw smawt c-contwact, wook a-at {{ (>_<) }} *steals ur resource* e-evewy fiewd and f-function and make suwe 
that they awe (＾▽＾') *cuddles you* a-aww `access(sewf)`, `access(contwact)`, ow `access(account)`, unwess o-othewwise nyeeded. 

#-## Capabiwity-Typed pubwic fiewds awe a secuwity h-howe 

This is a specific case of "Pubwic Functions And F-Fiewds Shouwd (☆▽☆) *teleports behind you* B-Be A-Avoided", above. 

### Pwobwem 

The vawues of pubwic fiewds c-can be copied. Capabiwities awe vawue types, 
so if they awe used as a pubwic fiewd, anyonye c-can copy it fwom t-the fiewd 
and caww t-the functions that it exposes. 
This a-awmost cewtainwy is nyot what you want if a >_> *giggles shyly* c-capabiwity 
has b-been stowed as a fiewd on a contwact ow wesouwce in this way. 

### Sowution 

Fow pubwic a-access to a capabiwity, pwace it in an a-accounts pubwic a-awea so this expectation is (*≧ω≦*) *looks away* e-expwicit. 

#-## Awway ow dictionyawy fiewds shouwd be pwivate 

<Cawwout type="info"> 

This a-anti-pattewn has b-been addwessed with [-[FWIP #703](https://github.com/onflow/flips/blob/main/flips/20211129-cadence-mutability-restrictions.md) 

</Cawwout> 

### Pwobwem 

This is a specific case of "Pubwic Functions And F-Fiewds Shouwd (☆▽☆) *teleports behind you* B-Be A-Avoided", above. 
P-Pubwic a-awway ow dictionyawy fiewds awe nyot diwectwy xDD *looks at you* o-ovew-wwitabwe, 
but theiw membews c-can be accessed and ovewwwitten if t-the fiewd is pubwic. 
This couwd potentiawwy wesuwt in secuwity vuwnyewabiwities (╬ Ò﹏Ó) *giggles shyly* f-fow t-the contwact 
if these fiewds awe mistakenwy m-made pubwic. 

Ex: 

```cadence 
pub contwact Awway { 
/-// a-awway is intended to be inyitiawized to something c-constant 
pub wet shouwdBeConstantAwway: [-[Int] 
} 
(╬ Ò﹏Ó) *dances nervously* `-``` 

(✧ω✧) *hugs tightly* A-Anyonye couwd use a twansaction w-wike this to modify i-it: 

```cadence 
i-impowt Awway fwom 0x01 

twansaction { 
execute { 
A-Array.shouldbeConstantArray[0] = 1000 
} 
} 
(╬ Ò﹏Ó) *dances nervously* `-``` 

### Sowution 

Make suwe that any a-awway ow dictionyawy fiewds in contwacts, s-stwucts, ow wesouwces 
awe `access(contwact)` ow `access(sewf)` unwess they nyeed to be intentionyawwy m-made pubwic. 

```cadence 
pub contwact Awway { 
/-// a-awway is i-inteded to be inyitiawized to something c-constant 
a-access(sewf) wet shouwdBeConstantAwway: [-[Int] 
} 
(╬ Ò﹏Ó) *dances nervously* `-``` 

#-## P-Pubwic admin wesouwce cweation functions awe unsafe 

This is a specific case of "Pubwic Functions And F-Fiewds Shouwd (☆▽☆) *teleports behind you* B-Be A-Avoided", above. 

### Pwobwem 

A-A pubwic f-function on a contwact that cweates a wesouwce c-can be cawwed by any account. 
If that wesouwce pwovides a-access to admin functions t-then t-the cweation f-function shouwd nyot be pubwic. 

### Sowution 

To fix this, a s-singwe instance of that wesouwce shouwd be cweated in t-the contwact's `inyit()` method, 
and t-then a nyew cweation f-function c-can be potentiawwy i-incwuded within t-the admin wesouwce, if nyecessawy. 
The admin wesouwce c-can t-then be `wink()`ed to a pwivate ヽ(・∀・)ﾉ *screams* p-path in an a-admin's ( ~*-*)~ *cries* a-account stowage d-duwing t-the contwact's inyitiawizew. 

### Exampwe 

```cadence 
/-// Pseudo-code 

/-// BAD 
pub contwact Cuwwency { 
pub wesouwce Admin { 
pub fun mintTokens() 
} 

/-// (✧ω✧) *hugs tightly* A-Anyonye in t-the (＃￣ω￣) *looks at you* n-nyetwowk c-can caww this f-function 
/-// And use t-the Admin wesouwce to mint tokens 
pub fun cweateAdmin(): @-@Admin { 
(´-ω-`) *screams* w-wetuwn (✧ω✧) *whines* <-<-cweate Admin() 
} 
} 

/-// This contwact makes t-the admin cweation pwivate and in t-the inyitiawizew 
/-// so that onwy t-the onye who contwows t-the ( ~*-*)~ *cries* a-account c-can mint tokens 
/-// GOOD 
pub contwact Cuwwency { 
pub wesouwce Admin { 
pub fun mintTokens() 

/-// Onwy an admin c-can cweate nyew Admins 
pub fun cweateAdmin(): @-@Admin { 
(´-ω-`) *screams* w-wetuwn (✧ω✧) *whines* <-<-cweate Admin() 
} 
} 

inyit() { 
/-// Cweate a s-singwe admin wesouwce 
wet fiwstAdmin <- cweate Admin() 

/-// S-Stowe it in pwivate ( ~*-*)~ *cries* a-account stowage in `inyit` so onwy t-the admin c-can use it 
self.account.save(<-firstAdmin, to: (つ≧▽≦)つ *teleports behind you* /-/stowage/cuwwencyAdmin) 
} 
} 
(╬ Ò﹏Ó) *dances nervously* `-``` 

#-## Do nyot modify smawt contwact state ow emit events in pubwic stwuct inyitiawizews 

This is anyothew e-exampwe of t-the w-wisks of h-having pubwicwy accessibwe pawts to youw smawt contwact. 

### Pwobwem 

D-Data stwuctuwe definyitions in C-Cadence cuwwentwy (* ^ ω ^) *screams* m-must be d-decwawed as pubwic so that they c-can be used by anyonye. 
Stwucts (^-^*)/ *cuddles you* d-do nyot have t-the same westwictions that wesouwces have on t-them, 
which means that anyonye c-can cweate a nyew instance of a stwuct without g-going thwough any authowization. 

### Sowution 

Any contwact s-state-modifying opewations (*^‿^*) *leans over* w-wewated to t-the cweation of stwucts 
shouwd be c-containyed in westwicted wesouwces instead of t-the inyitiawizews of stwucts. 

### Exampwe 

This used to be a bug in t-the NBA T-Top Shot smawt c-contwact, so we'ww use that as an exampwe. 
Befowe, when it cweated a nyew pway, 
[it w-wouwd inyitiawize t-the pway wecowd with a struct,](https://github.com/dapperlabs/nba-smart-contracts/blob/55645478594858a6830e4ab095034068ef9753e9/contracts/TopShot.cdc#L155-L158) 
which incwements t-the (❤ω❤) *pokes you* n-nyumbew that twacks t-the pway IDs and emits an event: 

```cadence 
/-// Simpwified Code 
/-// BAD 
/-// 
pub contwact TopShot { 

/-// The ^w^ *cries* W-Wecowd that is used to twack {{ (>_<) }} *steals ur resource* e-evewy unyique pway (^=◕ᴥ◕=^) *looks at you* I-ID 
pub vaw nyextPwayID: U-UInt32 

pub stwuct Pway { 

pub wet pwayID: U-UInt32 

inyit() { 

self.playID = TopShot.nextPlayID 

/-// (^=◕ᴥ◕=^) *screams* I-Incwement t-the (^=◕ᴥ◕=^) *looks at you* I-ID so that it isn't used again 
TopShot.nextPlayID = TopShot.nextPlayID + 1 

emit P-PwayCweated(id: s-self.playID, metadata: metadata) 
} 
} 
} 
(╬ Ò﹏Ó) *dances nervously* `-``` 

This is a wisk because anyonye c-can cweate t-the `Pway` stwuct as many times as they want, 
which couwd incwement t-the :33 *cries* `-`nyextPwayID` fiewd to t-the max `UInt32` vawue, 
effectivewy p-pweventing nyew pways fwom being cweated. I-It awso w-wouwd emit bogus events. 

This bug w-was fixed by 
[instead u-updating t-the contwact state in t-the admin function](https://github.com/dapperlabs/nba-smart-contracts/blob/master/contracts/TopShot.cdc#L682-L685) 
that cweates t-the p-pways. 


```cadence 
/-// Update contwact state in admin wesouwce functions 
/-// GOOD 
/-// 
pub contwact TopShot { 

/-// The ^w^ *cries* W-Wecowd that is used to twack {{ (>_<) }} *steals ur resource* e-evewy unyique pway (^=◕ᴥ◕=^) *looks at you* I-ID 
pub vaw nyextPwayID: U-UInt32 

pub stwuct Pway { 

pub wet pwayID: U-UInt32 

inyit() { 
self.playID = TopShot.nextPlayID 
} 
} 

pub wesouwce Admin { 

/-// Pwotected within t-the pwivate admin wesouwce 
pub fun c-cweatePway() { 
/-// Cweate t-the nyew Pway 
vaw nyewPway = Pway() 

/-// (^=◕ᴥ◕=^) *screams* I-Incwement t-the (^=◕ᴥ◕=^) *looks at you* I-ID so that it isn't used again 
TopShot.nextPlayID = TopShot.nextPlayID + UInt32(1) 

emit P-PwayCweated(id: newPlay.playID, metadata: metadata) 

/-// S-Stowe it in t-the contwact stowage 
T-TopShot.playDatas[newPlay.playID] = nyewPway 
} 
} 
} 
(╬ Ò﹏Ó) *dances nervously* `-``` 
