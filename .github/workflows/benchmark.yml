name: Benchmark

on:
  workflow_dispatch:
  push:
    branches:
      - master
      - 'feature/**'
      - 'v**'
  pull_request:
    branches:
      - master
      - 'feature/**'
      - 'v**'

env:
  GO_VERSION: '1.23'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

jobs:
  benchmark:
    name: Performance regression check
    runs-on: ubuntu-latest
    steps:

      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Detect changed components
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            encoding:
              - 'encoding/**'
            parser:
              - 'parser/**'
            sema:
              - 'sema/**'
            bbq:
              - 'bbq/**'

      - name: Set benchmark settings
        # reducing repetition and time will speed up execution,
        # but will be more inaccurate at detecting change
        run: |
          echo "benchmark_repetitions=2" >> "$GITHUB_OUTPUT"
          echo "benchmark_time=2s" >> "$GITHUB_OUTPUT"

        id: settings

      - uses: actions/setup-go@v3
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run unconditional benchmarks, on current branch
        run: make bench-common BENCH_REPS=${{ steps.settings.outputs.benchmark_repetitions }} BENCH_TIME=${{ steps.settings.outputs.benchmark_time }} | tee new.txt

      - name: Test
        run: |
          for val in ${ steps.changes.outputs }; do
            if [ "$val" == "true" ]; then
              echo "Running benchmarks for $val"
              make bench BENCH_PKGS=./$val/... BENCH_REPS=${{ steps.settings.outputs.benchmark_repetitions }} BENCH_TIME=${{ steps.settings.outputs.benchmark_time }} | tee -a new.txt
            fi
          done

      - name: Run encoding benchmarks, on current branch
        if: steps.changes.outputs.encoding == 'true'
        run: make bench BENCH_PKGS=./encoding/... BENCH_REPS=${{ steps.settings.outputs.benchmark_repetitions }} BENCH_TIME=${{ steps.settings.outputs.benchmark_time }} | tee -a new.txt

      - name: Run parser benchmarks, on current branch
        if: steps.changes.outputs.parser == 'true'
        run: make bench BENCH_PKGS=./parser/... BENCH_REPS=${{ steps.settings.outputs.benchmark_repetitions }} BENCH_TIME=${{ steps.settings.outputs.benchmark_time }} | tee -a new.txt

      - name: Run sema benchmarks, on current branch
        if: steps.changes.outputs.sema == 'true'
        run: make bench BENCH_PKGS=./sema/... BENCH_REPS=${{ steps.settings.outputs.benchmark_repetitions }} BENCH_TIME=${{ steps.settings.outputs.benchmark_time }} | tee -a new.txt

      - name: Run compiler/VM benchmarks, on current branch
        if: steps.changes.outputs.bbq == 'true'
        run: make bench BENCH_PKGS=./bbq/... BENCH_REPS=${{ steps.settings.outputs.benchmark_repetitions }} BENCH_TIME=${{ steps.settings.outputs.benchmark_time }} | tee -a new.txt

      - name: Checkout base branch
        run: git checkout ${{ github.event.pull_request.base.sha }}

      - name: Run unconditional benchmarks, on base branch
        run: make bench-common BENCH_REPS=${{ steps.settings.outputs.benchmark_repetitions }} BENCH_TIME=${{ steps.settings.outputs.benchmark_time }} | tee old.txt

      - name: Run encoding benchmarks, on current branch
        if: steps.changes.outputs.encoding == 'true'
        run: make bench BENCH_PKGS=./encoding/... BENCH_REPS=${{ steps.settings.outputs.benchmark_repetitions }} BENCH_TIME=${{ steps.settings.outputs.benchmark_time }} | tee -a old.txt

      - name: Run parser benchmarks, on current branch
        if: steps.changes.outputs.parser == 'true'
        run: make bench BENCH_PKGS=./parser/... BENCH_REPS=${{ steps.settings.outputs.benchmark_repetitions }} BENCH_TIME=${{ steps.settings.outputs.benchmark_time }} | tee -a old.txt

      - name: Run sema benchmarks, on current branch
        if: steps.changes.outputs.sema == 'true'
        run: make bench BENCH_PKGS=./sema/... BENCH_REPS=${{ steps.settings.outputs.benchmark_repetitions }} BENCH_TIME=${{ steps.settings.outputs.benchmark_time }} | tee -a old.txt

      - name: Run compiler/VM benchmarks, on current branch
        if: steps.changes.outputs.bbq == 'true'
        run: make bench BENCH_PKGS=./bbq/... BENCH_REPS=${{ steps.settings.outputs.benchmark_repetitions }} BENCH_TIME=${{ steps.settings.outputs.benchmark_time }} | tee -a old.txt

      # see https://trstringer.com/github-actions-multiline-strings/ to see why this part is complex
      - name: Use benchstat for comparison
        run: |
          export PATH=$PATH:$(go env GOPATH)/bin
          make install-benchstat
          echo "BENCHSTAT<<EOF" >> $GITHUB_ENV
          echo "$(benchstat -html -sort name old.txt new.txt | sed  '/<title/,/<\/style>/d' | sed 's/<!doctype html>//g')" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Find existing comment on PR
        uses: peter-evans/find-comment@v1
        id: fc
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: "github-actions[bot]"
          body-includes: "## [Benchstat](https://pkg.go.dev/golang.org/x/perf/cmd/benchstat) comparison"

      - name: Create or update comment
        uses: peter-evans/create-or-update-comment@v1
        with:
          comment-id: ${{ steps.fc.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## [Benchstat](https://pkg.go.dev/golang.org/x/perf/cmd/benchstat) comparison

            - Base branch: ${{  github.event.pull_request.base.label }}
            - Base commit: ${{ github.event.pull_request.base.sha }}

            <details>
            <summary>Results</summary>
            <p>

            ${{ env.BENCHSTAT }}

            </p>
            </details>

          edit-mode: replace
